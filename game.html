<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Jingooth Fusion üçâ</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One:wght@700;900&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#fde2f3; --bg2:#d8dcff; --score:#ff4f8a; --accent:#8aa7ff;
  }
  html,body{margin:0;padding:0;width:100%;height:100%;overflow:hidden;background:linear-gradient(180deg,var(--bg1),var(--bg2));font-family:'Fredoka One',system-ui,sans-serif;touch-action:none;}
  /* ‡πÄ‡∏•‡∏¢‡πå‡πÄ‡∏≠‡∏≤‡∏ï‡πå‡∏™‡πÑ‡∏ï‡∏•‡πå Suika: canvas ‡∏Ñ‡∏á‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô 420x740 ‡πÅ‡∏•‡πâ‡∏ß‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á */
  #stageWrap{position:relative; width:100vw; height:100vh; display:flex; align-items:center; justify-content:center;}
  #game{display:block; width:100vw; height:100vh; aspect-ratio:420/740; max-height:100vh; background:#eef1ff; border-radius:20px; box-shadow:0 8px 22px rgba(0,0,0,.2);}
  /* ‡πÄ‡∏™‡πâ‡∏ô‡∏ö‡∏ô (‡∏Ç‡∏≠‡∏ö‡∏ö‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô) */
  .top-line{position:absolute; width:78vw; max-width:330px; height:8px; border-radius:10px;
    background:repeating-linear-gradient(90deg,#ffd7ef,#ffd7ef 12px,#fff0fa 12px,#fff0fa 24px);
    left:50%; transform:translateX(-50%); top:16vh; box-shadow:0 2px 6px rgba(255,200,230,.45);}
  /* ‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏ä‡∏¥‡πâ‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ */
  #preview{position:absolute; width:64px; height:64px; top:11vh; left:50%; transform:translateX(-50%); pointer-events:none;
    filter:drop-shadow(0 3px 3px rgba(0,0,0,.18));}
  /* ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô */
  .score{position:absolute; top:2.2vh; left:50%; transform:translateX(-50%);
    background:#fff; border:3px solid var(--score); color:var(--score); border-radius:18px; padding:6px 14px;
    font-size:24px; font-weight:900; text-shadow:1px 1px 0 #fff; box-shadow:0 3px 8px rgba(0,0,0,.12);}
  .pulse{animation:scorePulse .28s ease-in-out;}
  @keyframes scorePulse{0%{transform:translateX(-50%) scale(1);}50%{transform:translateX(-50%) scale(1.25);}100%{transform:translateX(-50%) scale(1);}}
  /* ‡πÅ‡∏ú‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°/‡∏à‡∏ö‡πÄ‡∏Å‡∏° */
  .panel{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.42); z-index:10;}
  .card{background:#fff; border-radius:20px; width:min(86vw,420px); padding:22px 18px; text-align:center; box-shadow:0 12px 30px rgba(0,0,0,.25);}
  .card h1{margin:0 0 8px; color:var(--score); font-size:22px; white-space:nowrap;}
  .card p{margin:0 0 12px; color:#555; font-size:14px;}
  .btn{border:none; border-radius:12px; padding:12px 18px; margin:6px; font-weight:800; color:#fff; cursor:pointer; font-size:16px;}
  .primary{background:var(--accent);}
  .secondary{background:linear-gradient(145deg,#ffa8d8,#ffbde5); border:2px solid #ff87ca;}
  footer{position:fixed; bottom:8px; right:10px; color:#7a9cff; font-size:13px; font-weight:600; text-shadow:0 1px 2px rgba(255,255,255,.8);}
</style>
<script defer src="https://cdn.jsdelivr.net/npm/matter-js@0.19.0/build/matter.min.js"></script>
</head>
<body>
<div id="stageWrap">
  <canvas id="game" width="420" height="740"></canvas>
  <img id="preview" src="" alt="">
  <div class="top-line"></div>
  <div class="score">‚≠ê <span id="score">0</span></div>
</div>

<div id="panel" class="panel">
  <div class="card">
    <h1>Smile with Yeo Jin-goo üíï</h1>
    <p>Tap to drop and merge the smiling faces!</p>
    <button class="btn primary" id="btnStart">Start Game</button>
    <button class="btn secondary" id="btnBack" style="display:none" onclick="location.href='index.html'">üè† Back to Main</button>
  </div>
</div>

<footer>by: namaoi.sweet üíï</footer>

<!-- ‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á ‡πÉ‡∏´‡πâ‡∏ß‡∏≤‡∏á‡πÉ‡∏ô /public/sounds ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô src ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢) -->
<audio id="sDrop"  src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_2f5a0e7b8f.mp3?filename=pop-94319.mp3" preload="auto"></audio>
<audio id="sMerge" src="https://cdn.pixabay.com/download/audio/2021/09/06/audio_00e08ad807.mp3?filename=soft-bling-1046.mp3" preload="auto"></audio>
<audio id="sOver"  src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_34563f6ef3.mp3?filename=cute-little-failure-94669.mp3" preload="auto"></audio>

<script>
(() => {
  // ====== CONFIG (‡∏™‡πÑ‡∏ï‡∏•‡πå Suika) ======
  const W = 420, H = 740;               // world ‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ñ‡∏á‡∏ó‡∏µ‡πà
  const PLAY_W = 360, WALL = (W - PLAY_W)/2; // ‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏ß‡πâ‡∏≤‡∏á 360px ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏•‡∏≤‡∏á
  const FLOOR_Y = 700;
  const TOP_SENSOR_Y = 150;             // ‡πÄ‡∏™‡πâ‡∏ô‡∏ö‡∏ô‡∏Ç‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏•‡πà‡∏ô (‡∏ï‡πâ‡∏≠‡∏á "‡∏•‡πâ‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ô‡∏µ‡πâ" ‡∏ñ‡∏∂‡∏á‡∏à‡∏ö‡πÄ‡∏Å‡∏°)
  const SAFE_AFTER = 8;                 // ‡∏°‡∏µ‡∏ä‡∏¥‡πâ‡∏ô >= 8 ‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ä‡πá‡∏Å Game Over
  const DROP_COOLDOWN = 420;            // ‡∏Å‡∏±‡∏ô‡∏î‡∏£‡∏≠‡∏õ‡∏ã‡πâ‡∏≥‡∏à‡∏≤‡∏Å pointer event ‡∏ã‡πâ‡∏≠‡∏ô
  const IMG_COUNT = 12;
  const IMG_PATHS = Array.from({length:IMG_COUNT}, (_,i)=>`images/face${i+1}.png`);

  // ====== State ======
  let Engine, Render, World, Bodies, Body, Events, Composite;
  let engine, world, render;
  let textures = [];
  let nextLevel = 1;
  let score = 0;
  let allowDrop = false;
  let lastDropAt = 0;
  let gameOver = false;

  // DOM
  const canvas = document.getElementById('game');
  const scoreEl = document.getElementById('score');
  const preview = document.getElementById('preview');
  const panel = document.getElementById('panel');
  const btnStart = document.getElementById('btnStart');
  const btnBack = document.getElementById('btnBack');

  // ‡πÄ‡∏™‡∏µ‡∏¢‡∏á + ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å
  const sDrop  = document.getElementById('sDrop');
  const sMerge = document.getElementById('sMerge');
  const sOver  = document.getElementById('sOver');
  let audioUnlocked = false;
  function unlockAudio(){
    if (audioUnlocked) return;
    // iOS/Android ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏°‡∏µ gesture ‡∏Å‡πà‡∏≠‡∏ô ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏î‡πâ
    [sDrop,sMerge,sOver].forEach(a => {
      a.play().then(()=>{ a.pause(); a.currentTime = 0; }).catch(()=>{});
    });
    audioUnlocked = true;
  }

  // ====== Utils ======
  function randNextLevel(){
    const r = Math.random();
    nextLevel = r < .6 ? 1 : r < .85 ? 2 : r < .95 ? 3 : 4;
    preview.src = textures[nextLevel-1].src;
  }
  function worldX(clientX){
    const rect = canvas.getBoundingClientRect();
    // map ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ ‚Üí world (420 ‡∏Å‡∏ß‡πâ‡∏≤‡∏á)
    return (clientX - rect.left) * (W / rect.width);
  }

  // ====== Matter setup ======
  async function loadImages(paths){
    return Promise.all(paths.map(src=>new Promise((res,rej)=>{
      const img = new Image();
      img.onload=()=>res(img);
      img.onerror=rej;
      img.src=src;
    })));
  }

  function setupMatter(){
    Engine = Matter.Engine; Render = Matter.Render; World = Matter.World;
    Bodies = Matter.Bodies; Body = Matter.Body; Events = Matter.Events; Composite = Matter.Composite;

    engine = Engine.create();
    render = Render.create({
      canvas, engine,
      options: { width: W, height: H, wireframes:false, background:'transparent' }
    });
    world = engine.world;

    // ‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÅ‡∏ö‡∏ö‡∏Å‡∏£‡∏≠‡∏ö‡πÄ‡∏•‡πà‡∏ô (‡∏™‡πÑ‡∏ï‡∏•‡πå Suika)
    const floor = Bodies.rectangle(W/2, FLOOR_Y+20, PLAY_W, 40, { isStatic:true });
    const left  = Bodies.rectangle(WALL, H/2, 20, H, { isStatic:true });
    const right = Bodies.rectangle(W - WALL, H/2, 20, H, { isStatic:true });

    // ‡πÄ‡∏ã‡∏ô‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÄ‡∏™‡πâ‡∏ô‡∏ö‡∏ô
    const topSensor = Bodies.rectangle(W/2, TOP_SENSOR_Y, PLAY_W-10, 6, {
      isStatic:true, isSensor:true, label:'topSensor'
    });

    World.add(world, [floor, left, right, topSensor]);

    // ‡∏£‡∏ß‡∏°‡∏ä‡∏¥‡πâ‡∏ô (merge) ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ä‡∏ô‡∏Å‡∏±‡∏ô‡∏ä‡πâ‡∏≤ ‡πÜ ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô
    Events.on(engine,'collisionStart', e=>{
      for(const p of e.pairs){
        const a=p.bodyA, b=p.bodyB;
        if(a.isSensor || b.isSensor) continue;
        if(a.custom && b.custom && a.custom.level === b.custom.level && !a.merged && !b.merged){
          // ‡∏Å‡∏±‡∏ô‡∏ä‡∏ô‡πÅ‡∏£‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ
          const rel = Math.hypot(a.velocity.x-b.velocity.x, a.velocity.y-b.velocity.y);
          if(rel < 2.2){
            a.merged = b.merged = true;
            // ‡∏´‡∏ô‡πà‡∏ß‡∏á‡∏ô‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏°‡∏±‡∏ô‡∏ô‡∏¥‡πà‡∏á‡∏Å‡πà‡∏≠‡∏ô
            setTimeout(()=>doMerge(a,b), 90);
          }
        }
      }
    });

    // Game Over ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏£‡∏ì‡∏µ "‡∏ä‡∏¥‡πâ‡∏ô‡∏•‡πâ‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ö‡∏ô" + ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ä‡∏¥‡πâ‡∏ô‡∏û‡∏≠‡∏™‡∏°‡∏Ñ‡∏ß‡∏£‡πÅ‡∏•‡πâ‡∏ß
    Events.on(engine,'collisionActive', e=>{
      // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏û‡∏¥‡πÄ‡∏®‡∏©: ‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏ä‡∏¥‡πâ‡∏ô >= SAFE_AFTER
      const pieces = Composite.allBodies(world).filter(b=>b.custom);
      if(pieces.length < SAFE_AFTER) return;

      for(const p of e.pairs){
        const a=p.bodyA, b=p.bodyB;
        if((a.label==='topSensor' && b.custom) || (b.label==='topSensor' && a.custom)){
          // ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏≤‡∏Å "‡∏Ç‡∏≠‡∏ö‡∏ö‡∏ô‡∏à‡∏£‡∏¥‡∏á" ‡∏Ç‡∏≠‡∏á‡∏ß‡∏á‡∏Å‡∏•‡∏° ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà center
          const body = a.label==='topSensor'? b : a;
          const topEdge = body.position.y - (body.circleRadius||0);
          if(topEdge < TOP_SENSOR_Y){ // ‡∏ä‡∏ô‡∏ó‡∏∞‡∏•‡∏∏‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
            return endGame();
          }
        }
      }
    });

    Matter.Runner.run(Matter.Runner.create(), engine);
    Render.run(render);
  }

  function addPiece(level, x){
    const r = 18 + level*6;
    const img = textures[level-1];
    const clamped = Math.max(WALL+25, Math.min(W - WALL - 25, x));
    const body = Bodies.circle(clamped, 80, r, {
      restitution: 0.2, friction: 0.001,
      render: { sprite: { texture: img.src, xScale: (r*2)/img.width, yScale:(r*2)/img.height } }
    });
    body.custom = { level };
    World.add(world, body);
    try{ sDrop.currentTime=0; sDrop.play(); }catch{}
    return body;
  }

  function doMerge(a,b){
    const lvl = a.custom.level;
    const nx = (a.position.x + b.position.x)/2;
    const ny = (a.position.y + b.position.y)/2;
    World.remove(world, a); World.remove(world, b);
    if(lvl < IMG_COUNT){
      const c = addPiece(lvl+1, nx);
      Body.setPosition(c, {x:nx, y:ny});
      score += lvl * 10;
      try{ sMerge.currentTime=0; sMerge.play(); }catch{}
    } else {
      score += lvl * 25;
    }
    scoreEl.textContent = score;
    scoreEl.parentElement.classList.add('pulse');
    setTimeout(()=>scoreEl.parentElement.classList.remove('pulse'), 280);
  }

  function dropOnce(x){
    const now = Date.now();
    if(!allowDrop || gameOver || (now - lastDropAt) < DROP_COOLDOWN) return; // ‡∏Å‡∏±‡∏ô‡∏î‡∏£‡∏≠‡∏õ‡∏ã‡πâ‡∏≥
    lastDropAt = now;
    addPiece(nextLevel, x);
    randNextLevel();
  }

  // ====== Controls (Pointer Events ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á mouse/touch) ======
  function initControls(){
    let pointerX = W/2;

    const onMove = (ev)=>{
      const rect = canvas.getBoundingClientRect();
      const clientX = ev.clientX ?? (ev.touches && ev.touches[0].clientX);
      if(clientX==null) return;
      // map ‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î world (420)
      pointerX = (clientX - rect.left) * (W / rect.width);
      // ‡∏¢‡πâ‡∏≤‡∏¢‡∏£‡∏π‡∏õ preview ‡∏ï‡∏≤‡∏°‡∏ô‡∏¥‡πâ‡∏ß
      const px = clientX; // ‡πÉ‡∏ä‡πâ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ preview ‡∏ã‡πâ‡∏≠‡∏ô‡∏ï‡∏£‡∏á‡∏ô‡∏¥‡πâ‡∏ß
      preview.style.left = px + 'px';
    };

    const onUp = (ev)=>{
      const rect = canvas.getBoundingClientRect();
      const clientX = ev.clientX ?? (ev.changedTouches && ev.changedTouches[0].clientX);
      if(clientX==null) return;
      const xWorld = (clientX - rect.left) * (W / rect.width);
      dropOnce(xWorld);
    };

    // ‡πÉ‡∏ä‡πâ pointer events ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ, ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢ touch/mouse
    if(window.PointerEvent){
      canvas.addEventListener('pointermove', onMove, {passive:true});
      canvas.addEventListener('pointerup', onUp, {passive:true});
    }else{
      canvas.addEventListener('mousemove', onMove, {passive:true});
      canvas.addEventListener('touchmove', onMove, {passive:true});
      canvas.addEventListener('mouseup', onUp, {passive:true});
      canvas.addEventListener('touchend', onUp, {passive:true});
    }
  }

  function endGame(){
    if(gameOver) return;
    gameOver = true; allowDrop = false;
    try{ sOver.currentTime=0; sOver.play(); }catch{}
    panel.style.display = 'flex';
    panel.querySelector('h1').textContent = 'Game Over üí•';
    panel.querySelector('p').textContent  = 'Thanks for smiling with Yeo Jin Goo üå∏';
    btnStart.textContent = 'üîÑ Play Again';
    btnBack.style.display = 'inline-block';
  }

  async function boot(){
    textures = await loadImages(IMG_PATHS);
    await setupMatter();
    initControls();
    randNextLevel();
    allowDrop = true;
  }

  // Start / Restart
  btnStart.addEventListener('click', ()=>{
    unlockAudio();
    panel.style.display = 'none';
    if(engine){
      // ‡∏•‡πâ‡∏≤‡∏á‡∏ä‡∏¥‡πâ‡∏ô‡πÄ‡∏î‡∏¥‡∏°
      Composite.allBodies(world).forEach(b=>{ if(!b.isStatic) World.remove(world,b); });
      score = 0; scoreEl.textContent = '0'; gameOver=false; lastDropAt=0;
      randNextLevel(); allowDrop = true; btnBack.style.display='none';
    }else{
      boot();
    }
  });

})();
</script>
</body>
</html>
