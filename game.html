<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Jingooth Fusion üçâ</title>

<style>
/* -------------------------
   Base & Layout
------------------------- */
html,body{
  margin:0;padding:0;width:100%;height:100%;
  background:linear-gradient(180deg,#fde2f3,#d8dcff);
  font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Noto Sans Thai',sans-serif;
  overflow:hidden;touch-action:none;
}
#gameContainer{
  position:relative;width:100%;height:100%;
  display:flex;justify-content:center;align-items:center;
}
canvas.main {
  aspect-ratio:420/648;
  width:100%;max-width:480px;height:auto;
  background:#eef1ff;border-radius:20px;
  box-shadow:0 6px 14px rgba(0,0,0,.2);
}
canvas.fx {
  position:absolute;inset:0;margin:auto;
  width:100%;max-width:480px;height:auto;
  aspect-ratio:420/648;
  pointer-events:none;
}
.cute-line{
  position:absolute;top:17%;left:50%;transform:translateX(-50%);
  width:78%;height:6px;border-radius:10px;
  background:repeating-linear-gradient(90deg,#ffd7ef,#ffd7ef 12px,#fff0fa 12px,#fff0fa 24px);
  box-shadow:0 2px 6px rgba(255,200,230,.4);
}
#preview{ position:absolute;top:11%;left:50%;transform:translateX(-50%); width:70px;height:70px;pointer-events:none; }

/* Score */
.scorebox{
  position:absolute;top:3%;left:50%;transform:translateX(-50%);
  background:#fff8fb;border:3px solid #ff5b8a;border-radius:18px;
  padding:6px 16px;font-size:26px;color:#ff5b8a;font-weight:900;
  text-shadow:1px 1px 0 #fff;box-shadow:0 3px 8px rgba(0,0,0,0.1);
}
.pulse{animation:scorePulse .3s ease-in-out;}
@keyframes scorePulse{0%{transform:scale(1);}50%{transform:scale(1.25);}100%{transform:scale(1);}}

/* BGM toggle button */
.btn{
  border:none;border-radius:12px;padding:12px 18px;margin:6px;
  font-weight:700;font-size:16px;color:#fff;cursor:pointer;
}
.btn.primary{background:#8aa7ff;}
.btn.secondary{background:linear-gradient(145deg,#ffa8d8,#ffbde5); border:2px solid #ff87ca;}
.btn.small{
  position:absolute;top:3%;right:4%;
  font-size:14px;background:#ffbde5;border:2px solid #ff87ca;color:#fff;
  border-radius:12px;padding:6px 10px;cursor:pointer;
  box-shadow:0 3px 6px rgba(0,0,0,.1);
}
.btn.small:active{transform:scale(0.95);}

/* Start / GameOver Panel */
.panel{
  position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
  background:rgba(0,0,0,0.45);z-index:10;text-align:center;
}
.card{
  background:#fff;border-radius:20px;padding:24px;width:85%;max-width:380px;
  box-shadow:0 10px 25px rgba(0,0,0,.25);
}
.card h1{font-size:22px;margin-bottom:8px;color:#ff5b8a;}
.card p{font-size:14px;color:#555;margin-bottom:12px;}

/* Realtime Leaderboard (Top 5) ‚Äì left-top under score */
.leaderboard{
  position:absolute;top:8%;left:4%;
  min-width:180px;max-width:220px;
  background:rgba(255,255,255,0.85);
  border:2px solid #e6e6e8;border-radius:14px;
  padding:8px 10px;box-shadow:0 4px 10px rgba(0,0,0,.08);
  display:none; /* ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á ‡∏à‡∏ô‡∏Å‡∏î Start */
}
.leaderboard h3{
  margin:0 0 6px 0;font-size:14px;font-weight:800;color:#7b7e8a;
}
.leaderboard ol{
  list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:4px;
}
.leaderboard li{
  font-size:13px;color:#9aa0aa;font-weight:700;
  background:#ffffff;border:1px solid #ececf1;border-radius:10px;
  padding:6px 8px;
}

/* Footer */
footer{
  position:fixed;bottom:8px;right:10px;
  color:#7a9cff;font-size:13px;font-weight:600;
  text-shadow:0 1px 2px rgba(255,255,255,.8);
}
</style>

<!-- Matter.js (‡∏ü‡∏¥‡∏™‡∏¥‡∏Å‡∏™‡πå) -->
<script defer src="https://cdn.jsdelivr.net/npm/matter-js@0.19.0/build/matter.min.js"></script>

</head>
<body>
  <div id="gameContainer">
    <canvas id="game" class="main" width="420" height="648"></canvas>
    <canvas id="fx" class="fx" width="420" height="648"></canvas>

    <div class="cute-line"></div>
    <img id="preview" src="">
    <div class="scorebox">‚≠ê <span id="score">0</span></div>

    <!-- Realtime Leaderboard (‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏•‡∏±‡∏á Start) -->
    <div id="lb" class="leaderboard">
      <h3>üèÜ Top 5 Smiles</h3>
      <ol id="lbList">
        <!-- rows filled by Firestore onSnapshot -->
      </ol>
    </div>

    <!-- Toggle BGM -->
    <button id="toggleBGM" class="btn small">üîä BGM On</button>
  </div>

  <!-- Start/GameOver Panel -->
  <div id="panel" class="panel">
    <div class="card">
      <h1>Smile with Yeo Jin-goo üíï</h1>
      <p>Tap to drop and merge the smiling faces!</p>
      <button class="btn primary" id="btnStart">Start Game</button>
      <button class="btn secondary" id="btnBack" style="display:none;" onclick="window.location.href='index.html'">üè† Back to Main</button>
    </div>
  </div>

  <footer>by: namaoi.sweet üíï</footer>

  <!-- Local audio assets (WAV first; ‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô sounds/ ‡πÅ‡∏•‡πâ‡∏ß) -->
  <audio id="aud-drop" preload="auto"><source src="sounds/drop.wav" type="audio/wav"></audio>
  <audio id="aud-merge" preload="auto"><source src="sounds/merge.wav" type="audio/wav"></audio>
  <audio id="aud-over" preload="auto"><source src="sounds/over.wav" type="audio/wav"></audio>
  <audio id="aud-bgm" preload="auto" loop><source src="sounds/bgm.wav" type="audio/wav"></audio>

<script>
/* ==========================================================
   Audio Subsystem v2 ‚Äî Hybrid WebAudio + HTMLAudio fallback
========================================================== */
let audioCtx=null,audioBuffers={},buffersReady=false,audioUnlocked=false,bgmPlayingEl=null;

const SOUND_URLS={drop:'sounds/drop.wav',merge:'sounds/merge.wav',over:'sounds/over.wav',bgm:'sounds/bgm.wav'};
const FALLBACK_CDN={ // ‡∏™‡∏≥‡∏£‡∏≠‡∏á (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏≤‡∏¢) ‚Äî ‡πÑ‡∏°‡πà‡∏Ñ‡πà‡∏≠‡∏¢‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ
  drop:'https://cdn.pixabay.com/download/audio/2022/03/15/audio_2f5a0e7b8f.mp3?filename=pop-94319.mp3',
  merge:'https://cdn.pixabay.com/download/audio/2021/09/06/audio_00e08ad807.mp3?filename=soft-bling-1046.mp3',
  over:'https://cdn.pixabay.com/download/audio/2022/03/15/audio_34563f6ef3.mp3?filename=cute-little-failure-94669.mp3',
  bgm:'https://cdn.pixabay.com/download/audio/2022/03/09/audio_bf188c76da.mp3?filename=happy-day-11157.mp3'
};

async function ensureAudioUnlocked(){
  if(audioUnlocked) return;
  if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  try{await audioCtx.resume();}catch{}
  // prime HTMLAudio (iOS require)
  for(const id of ['aud-drop','aud-merge','aud-over','aud-bgm']){
    const el=document.getElementById(id); if(!el) continue;
    try{ el.muted=true; await el.play().catch(()=>{}); el.pause(); el.currentTime=0; el.muted=false; }catch{}
  }
  audioUnlocked=true;
}
['pointerdown','touchstart','keydown'].forEach(evt=>{
  document.addEventListener(evt, async ()=>{
    if(!audioUnlocked){ await ensureAudioUnlocked(); await initAudio(); }
  }, {once:true, passive:true});
});

async function initAudio(){
  if(buffersReady) return;
  if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  const loadBuffer=async(urlPrimary,urlFallback)=>{
    try{ const r=await fetch(urlPrimary,{cache:'force-cache',mode:'cors'}); const ab=await r.arrayBuffer(); return await audioCtx.decodeAudioData(ab);
    }catch(e){
      try{ const r2=await fetch(urlFallback,{cache:'force-cache',mode:'cors'}); const ab2=await r2.arrayBuffer(); return await audioCtx.decodeAudioData(ab2);}catch(e2){return null;}
    }
  };
  audioBuffers.drop  = await loadBuffer(SOUND_URLS.drop,  FALLBACK_CDN.drop);
  audioBuffers.merge = await loadBuffer(SOUND_URLS.merge, FALLBACK_CDN.merge);
  audioBuffers.over  = await loadBuffer(SOUND_URLS.over,  FALLBACK_CDN.over);
  buffersReady=true;
}
function playSound(name,loop=false,vol=1){
  if(name==='bgm'){ playBGM(vol); return; }
  const canWA=audioCtx && audioCtx.state!=='closed' && audioBuffers[name];
  if(canWA){
    try{ if(audioCtx.state==='suspended') audioCtx.resume();
      const src=audioCtx.createBufferSource(); const gain=audioCtx.createGain();
      src.buffer=audioBuffers[name]; gain.gain.value=vol;
      src.connect(gain).connect(audioCtx.destination); src.start(0); return src;
    }catch(e){}
  }
  // fallback HTMLAudio
  const idMap={drop:'aud-drop',merge:'aud-merge',over:'aud-over'};
  const el=document.getElementById(idMap[name]); if(!el) return;
  const clone=el.cloneNode(); clone.volume=vol; clone.play().catch(()=>{});
}
function playBGM(vol=0.22){
  const el=document.getElementById('aud-bgm'); if(!el) return;
  el.loop=true; el.volume=vol; el.play().catch(()=>{}); bgmPlayingEl=el;
}
function stopBGM(){
  const el=bgmPlayingEl||document.getElementById('aud-bgm'); if(!el) return;
  try{ el.pause(); el.currentTime=0; }catch{} bgmPlayingEl=null;
}
/* BGM toggle */
const toggleBGMBtn=document.getElementById('toggleBGM');
let bgmOn=true;
toggleBGMBtn.addEventListener('click',()=>{
  bgmOn=!bgmOn;
  if(bgmOn){ playBGM(0.22); toggleBGMBtn.textContent='üîä BGM On'; }
  else { stopBGM(); toggleBGMBtn.textContent='üîá BGM Off'; }
});
</script>

<!-- =========================
     ‡πÄ‡∏Å‡∏°‡∏´‡∏•‡∏±‡∏Å + Sparkle FX
========================= -->
<script>
const IMG_COUNT=12;
const IMG_PATHS=Array.from({length:IMG_COUNT},(_,i)=>`images/face${i+1}.png`);
let Engine,Render,World,Bodies,Events,engine,world,textures=[];
let allowDrop=false,dropX=210,score=0,nextLevel=1,gameOver=false,lastDrop=0;
const canvas=document.getElementById('game');
const fxCanvas=document.getElementById('fx');
const fxCtx=fxCanvas.getContext('2d');
const scoreEl=document.getElementById('score');
const preview=document.getElementById('preview');
const panel=document.getElementById('panel');
const btnStart=document.getElementById('btnStart');
const btnBack=document.getElementById('btnBack');
const lbBox=document.getElementById('lb');
const lbList=document.getElementById('lbList');

// Sparkle FX
const fxParticles=[];
function sparkle(x,y){
  for(let i=0;i<16;i++){
    const ang=(Math.PI*2*i)/16+Math.random()*0.3;
    const spd=2+Math.random()*2.5;
    fxParticles.push({x,y,vx:Math.cos(ang)*spd,vy:Math.sin(ang)*spd,r:2.2+Math.random()*1.8,life:38+Math.random()*12});
  }
}
function renderFX(){
  fxCtx.clearRect(0,0,fxCanvas.width,fxCanvas.height);
  for(let i=fxParticles.length-1;i>=0;i--){
    const p=fxParticles[i];
    p.x+=p.vx; p.y+=p.vy; p.vy+=0.05; p.life--;
    const alpha=Math.max(0,p.life/50);
    fxCtx.beginPath(); fxCtx.fillStyle=`rgba(255,200,240,${alpha})`;
    fxCtx.arc(p.x,p.y,p.r,0,Math.PI*2); fxCtx.fill();
    if(p.life<=0) fxParticles.splice(i,1);
  }
  requestAnimationFrame(renderFX);
}
requestAnimationFrame(renderFX);

async function loadImages(){
  return Promise.all(IMG_PATHS.map(src=>new Promise((res,rej)=>{
    const img=new Image(); img.onload=()=>res(img); img.onerror=rej; img.src=src;
  })));
}
function setupMatter(){
  Engine=Matter.Engine; Render=Matter.Render; World=Matter.World; Bodies=Matter.Bodies; Events=Matter.Events;
  engine=Engine.create();
  const render=Render.create({canvas,engine,options:{width:420,height:648,wireframes:false,background:'transparent'}});
  world=engine.world;
  World.add(world,[
    Bodies.rectangle(210,660,420,40,{isStatic:true}),
    Bodies.rectangle(-20,324,40,648,{isStatic:true}),
    Bodies.rectangle(440,324,40,648,{isStatic:true})
  ]);
  Matter.Runner.run(Matter.Runner.create(),engine);
  Render.run(render);
  Events.on(engine,'collisionStart',e=>{
    for(const p of e.pairs){
      const a=p.bodyA,b=p.bodyB;
      if(a.custom&&b.custom&&a.custom.level===b.custom.level&&!a.merged&&!b.merged){
        a.merged=b.merged=true; setTimeout(()=>merge(a,b),100);
      }
    }
  });
}
function addPiece(level,x=210){
  const r=18+level*6,tex=textures[level-1];
  const body=Bodies.circle(x,90,r,{
    restitution:0.15,friction:0.001,
    render:{sprite:{texture:tex.src,xScale:(r*2)/tex.width,yScale:(r*2)/tex.height}}
  });
  body.custom={level};
  World.add(world,body);
  playSound('drop',false,0.5);
  return body;
}
function merge(a,b){
  const lvl=a.custom.level;
  const nx=(a.position.x+b.position.x)/2, ny=(a.position.y+b.position.y)/2;
  World.remove(world,a); World.remove(world,b);
  sparkle(nx,ny);
  if(lvl<IMG_COUNT){
    const c=addPiece(lvl+1,nx);
    Matter.Body.setPosition(c,{x:nx,y:ny});
    score+=lvl*10; playSound('merge',false,0.7);
  } else {
    score+=lvl*25;
  }
  scoreEl.textContent=score; scoreEl.classList.add('pulse');
  setTimeout(()=>scoreEl.classList.remove('pulse'),300);
  checkGameOver();
}
function scheduleNextLevel(){
  const r=Math.random();
  nextLevel=r<.6?1:r<.85?2:r<.95?3:4;
  preview.src=textures[nextLevel-1].src;
}
function dropPiece(){
  const now=Date.now();
  if(!allowDrop||gameOver||now-lastDrop<420) return;
  lastDrop=now;
  addPiece(nextLevel, Math.max(30, Math.min(390, dropX)));
  scheduleNextLevel();
}
function checkGameOver(){
  const all=Matter.Composite.allBodies(engine.world).filter(b=>b.custom);
  if(all.length<15) return;
  const nearTop=all.filter(b=>(b.position.y-(b.circleRadius||0))<120);
  if(nearTop.length>6) endGame();
}
function initControls(){
  const move=e=>{
    const rect=canvas.getBoundingClientRect();
    const clientX=e.touches?e.touches[0].clientX:e.clientX;
    const x=(clientX-rect.left)*(420/rect.width);
    dropX=Math.max(30,Math.min(390,x));
    preview.style.left=`${clientX}px`;
  };
  canvas.addEventListener('mousemove',move);
  canvas.addEventListener('touchmove',move,{passive:true});
  const dropOnce=()=>dropPiece();
  canvas.addEventListener('click',dropOnce);
  canvas.addEventListener('touchend',dropOnce,{passive:true});
}
async function boot(){
  textures=await loadImages();
  setupMatter(); initControls(); scheduleNextLevel(); allowDrop=true;
}
btnStart.addEventListener('click', async ()=>{
  await ensureAudioUnlocked();  // ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á
  await initAudio();            // ‡πÇ‡∏´‡∏•‡∏î buffer SFX
  playBGM(0.22);                // ‡πÄ‡∏õ‡∏¥‡∏î BGM
  panel.style.display='none';
  // ‡πÅ‡∏™‡∏î‡∏á Leaderboard (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á realtime ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)
  lbBox.style.display='block';
  startLeaderboardRealtime();   // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° Firestore ‡∏°‡∏∏‡∏°‡∏ã‡πâ‡∏≤‡∏¢‡∏ö‡∏ô
  if(engine){
    const bodies=Matter.Composite.allBodies(engine.world);
    for(const b of bodies){ if(!b.isStatic) Matter.World.remove(world,b); }
    score=0; scoreEl.textContent='0'; gameOver=false;
    scheduleNextLevel(); allowDrop=true; btnBack.style.display='none';
    return;
  }
  boot();
});
function endGame(){
  if(gameOver) return;
  gameOver=true; allowDrop=false;
  stopBGM(); playSound('over',false,0.8);
  panel.style.display='flex';
  panel.querySelector('h1').innerText='Game Over üí•';
  panel.querySelector('p').innerText='Thanks for smiling with Yeo Jin Goo üå∏';
  btnStart.textContent='üîÑ Play Again';
  btnBack.style.display='inline-block';
  // ‡πÄ‡∏ã‡∏ü‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏õ Firestore (‡∏´‡∏•‡∏±‡∏á‡∏à‡∏ö)
  saveScoreFlow();
}
</script>

<!-- =========================
     Firebase (via official CDN)
     * ‡πÉ‡∏ä‡πâ config ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì *
========================= -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script>
/* Firebase Config ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì */
const firebaseConfig = {
  apiKey: "AIzaSyAJZM3DMlhfo5GbGKd-8CTjGYQ6CPL2XxU",
  authDomain: "jingooth-fusion.firebaseapp.com",
  projectId: "jingooth-fusion",
  storageBucket: "jingooth-fusion.firebasestorage.app",
  messagingSenderId: "60755175841",
  appId: "1:60755175841:web:c61eeb6f4752171b4083e0",
  measurementId: "G-X5YQEXSLTB"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô */
async function saveScore(name, scoreVal){
  try {
    await db.collection("scores").add({
      name: name || "Guest",
      score: scoreVal|0,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
  } catch(e){ console.error("Save score error:", e); }
}

/* ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô (‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô localStorage) */
function getPlayerName(){
  let n = localStorage.getItem("playerName");
  if(!n){
    n = prompt("Enter your name:") || "Guest";
    localStorage.setItem("playerName", n);
  }
  return n;
}

/* Flow ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏°‡∏à‡∏ö ‚Üí ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å + ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤ */
async function saveScoreFlow(){
  const name = getPlayerName();
  await saveScore(name, parseInt(document.getElementById('score').textContent||"0",10));
  // realtime ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏à‡∏≤‡∏Å startLeaderboardRealtime()
}

/* ‡πÅ‡∏™‡∏î‡∏á Leaderboard ‡πÅ‡∏ö‡∏ö realtime (Top 5) */
let lbUnsub = null;
function startLeaderboardRealtime(){
  // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ã‡πâ‡∏≥
  if(lbUnsub) return;
  lbUnsub = db.collection("scores")
    .orderBy("score","desc")
    .limit(5)
    .onSnapshot((snap)=>{
      const list = document.getElementById('lbList');
      list.innerHTML = "";
      snap.forEach(doc=>{
        const d=doc.data();
        const name = (d.name||"Guest");
        const sc   = (d.score||0);
        const li = document.createElement('li');
        li.textContent = `${name} ‚Äî ${sc}`;
        list.appendChild(li);
      });
    }, (err)=>console.warn("onSnapshot error:", err));
}
</script>

<!-- =========================
     ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ Firestore Rules (10 ‡∏õ‡∏µ)
     ‡πÑ‡∏õ‡∏ó‡∏µ‡πà Firebase console ‚Üí Build ‚Üí Firestore Database ‚Üí Rules
     ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô:

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if request.time < timestamp.date(2035, 11, 22);
    }
  }
}

========================= -->
</body>
</html>
